"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var buffer_1 = require("buffer");
var crypto = require("crypto");
var constants = require("constants");
var semver = require("semver");
var vposConfig_1 = require("./request/vposConfig");
var nodeVersion = semver.clean(process.version);
var exceptions_1 = require("../exceptions");
var EncryptionUtil = (function () {
    function EncryptionUtil() {
    }
    EncryptionUtil.sign = function (privateKey, data) {
        try {
            var sign = crypto.createSign("RSA-SHA256");
            sign.update(data);
            return sign.sign(privateKey, "base64");
        }
        catch (error) {
            throw new exceptions_1.EncryptionException(error);
        }
    };
    EncryptionUtil.verify = function (publicKey, data, signature) {
        try {
            var verify = crypto.createVerify("RSA-SHA256");
            verify.update(data);
            return verify.verify(publicKey, signature, "base64");
        }
        catch (error) {
            throw new exceptions_1.EncryptionException(error);
        }
    };
    EncryptionUtil.encrypt = function (publicKey, plaintext) {
        try {
            var plainBuffer = EncryptionUtil.bufferFromString(plaintext);
            var crypt = void 0;
            if (semver.gte(nodeVersion, "0.11.14")) {
                crypt = crypto.publicEncrypt(publicKey, plainBuffer);
            }
            else {
                var NodeRSA = require("node-rsa");
                var key = new NodeRSA(publicKey);
                crypt = key.encrypt(plainBuffer);
            }
            return crypt.toString("base64");
        }
        catch (error) {
            throw new exceptions_1.EncryptionException(error);
        }
    };
    EncryptionUtil.decrypt = function (privateKey, plaintext, isBase64) {
        if (isBase64 === void 0) { isBase64 = false; }
        try {
            var plainBuffer = EncryptionUtil.bufferFromString(plaintext, isBase64 ? "base64" : "utf8");
            var crypt = void 0;
            if (semver.gte(nodeVersion, "0.11.14")) {
                crypt = crypto.privateDecrypt(privateKey, plainBuffer);
            }
            else {
                var NodeRSA = require("node-rsa");
                var key = new NodeRSA(privateKey);
                crypt = key.decrypt(plainBuffer);
            }
            return crypt.toString();
        }
        catch (error) {
            throw new exceptions_1.EncryptionException(error);
        }
    };
    EncryptionUtil.verifyBexSign = function (data, signature) {
        return EncryptionUtil.verify(EncryptionUtil.publicKey, data, signature);
    };
    EncryptionUtil.encryptWithBex = function (vposConfig) {
        if (vposConfig instanceof vposConfig_1.VposConfig) {
            var data = JSON.stringify(vposConfig);
            var encrypted = "";
            for (var i = 0; i <= data.length / 245; i++) {
                encrypted += EncryptionUtil.encrypt(EncryptionUtil.PublicKey, data.substr(i * 245, (i + 1) * 245)) + "|:*:|";
            }
            return encrypted;
        }
        else {
            return EncryptionUtil.encrypt(EncryptionUtil.PublicKey, vposConfig);
        }
    };
    EncryptionUtil.encode64 = function (data) {
        return EncryptionUtil.bufferFromString(data).toString("base64");
    };
    EncryptionUtil.decode64 = function (data) {
        return EncryptionUtil.bufferFromString(data, "base64").toString();
    };
    Object.defineProperty(EncryptionUtil, "PublicKey", {
        get: function () {
            return { key: EncryptionUtil.publicKey, padding: constants.RSA_PKCS1_PADDING };
        },
        enumerable: true,
        configurable: true
    });
    EncryptionUtil.bufferFromString = function (data, encoding) {
        if (encoding === void 0) { encoding = "utf8"; }
        if (semver.gte(nodeVersion, "6.0.0")) {
            return buffer_1.Buffer.from(data, encoding);
        }
        else {
            return new buffer_1.Buffer(data, encoding);
        }
    };
    return EncryptionUtil;
}());
EncryptionUtil.publicKey = "-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuZj/TQ9ZRY5KnsA3HMPq\nbNwI32J+Bisyv7KX7IRJh5rN5LW3g7t6pulArLIEU3sn28ZQEQ+GCb9yvk6zIUoq\nKBqH0H+gvxOtsklOUkFRgh+/FghNDoe0OzkXTLjQKhh6MRMBR9l3cws9nA2cu+M5\nkw67F8j0+4SogHJ+VS1wA2kfWx58PNDIg9DtAVwmD1JbjAziPONv0wHSa8oNgia9\nTx6ia6FS4nfjRNqpVqI0m2jIcG8yXt1OaBSazkuRlRepMtDVwMGF4xOWXuRVv+G5\noiTsbOez9tQAcx+KH0W1Pn9Q9/zzOJyF9AS8J1UDE7c7rKwXGDnuTBU1BwdAGyB8\n7QIDAQAB\n-----END PUBLIC KEY-----";
exports.EncryptionUtil = EncryptionUtil;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VjdXJpdHkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbWVyY2hhbnQvc2VjdXJpdHkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFPQSxpQ0FBOEI7QUFDOUIsK0JBQWlDO0FBQ2pDLHFDQUF1QztBQUN2QywrQkFBaUM7QUFDakMsbURBQWdEO0FBQ2hELElBQU0sV0FBVyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQ2xELDRDQUFrRDtBQUdsRDtJQUFBO0lBZ0hBLENBQUM7SUE5R2lCLG1CQUFJLEdBQWxCLFVBQW1CLFVBQWtCLEVBQUUsSUFBWTtRQUMvQyxJQUFJLENBQUM7WUFDRCxJQUFNLElBQUksR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQzdDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDbEIsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQzNDLENBQUM7UUFDRCxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ1gsTUFBTSxJQUFJLGdDQUFtQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3pDLENBQUM7SUFDTCxDQUFDO0lBRWEscUJBQU0sR0FBcEIsVUFBcUIsU0FBaUIsRUFBRSxJQUFZLEVBQUUsU0FBaUI7UUFDbkUsSUFBSSxDQUFDO1lBQ0QsSUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUNqRCxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3BCLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxTQUFTLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDekQsQ0FBQztRQUNELEtBQUssQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDWCxNQUFNLElBQUksZ0NBQW1CLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDekMsQ0FBQztJQUNMLENBQUM7SUFFYSxzQkFBTyxHQUFyQixVQUFzQixTQUFnQyxFQUFFLFNBQWlCO1FBQ3JFLElBQUksQ0FBQztZQUNELElBQU0sV0FBVyxHQUFXLGNBQWMsQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUN2RSxJQUFJLEtBQUssU0FBUSxDQUFDO1lBRWxCLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDckMsS0FBSyxHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQUMsU0FBUyxFQUFFLFdBQVcsQ0FBQyxDQUFDO1lBQ3pELENBQUM7WUFDRCxJQUFJLENBQUMsQ0FBQztnQkFDRixJQUFNLE9BQU8sR0FBUSxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7Z0JBQ3pDLElBQU0sR0FBRyxHQUFRLElBQUksT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUN4QyxLQUFLLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUNyQyxDQUFDO1lBQ0QsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDcEMsQ0FBQztRQUNELEtBQUssQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDWCxNQUFNLElBQUksZ0NBQW1CLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDekMsQ0FBQztJQUNMLENBQUM7SUFFYSxzQkFBTyxHQUFyQixVQUFzQixVQUFrQixFQUFFLFNBQWlCLEVBQUUsUUFBeUI7UUFBekIseUJBQUEsRUFBQSxnQkFBeUI7UUFDbEYsSUFBSSxDQUFDO1lBQ0QsSUFBTSxXQUFXLEdBQVcsY0FBYyxDQUFDLGdCQUFnQixDQUFDLFNBQVMsRUFBRSxRQUFRLEdBQUcsUUFBUSxHQUFHLE1BQU0sQ0FBQyxDQUFDO1lBQ3JHLElBQUksS0FBSyxTQUFRLENBQUM7WUFFbEIsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNyQyxLQUFLLEdBQUcsTUFBTSxDQUFDLGNBQWMsQ0FBQyxVQUFVLEVBQUUsV0FBVyxDQUFDLENBQUM7WUFDM0QsQ0FBQztZQUNELElBQUksQ0FBQyxDQUFDO2dCQUNGLElBQU0sT0FBTyxHQUFRLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztnQkFDekMsSUFBTSxHQUFHLEdBQVEsSUFBSSxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7Z0JBQ3pDLEtBQUssR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ3JDLENBQUM7WUFDRCxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQzVCLENBQUM7UUFDRCxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ1gsTUFBTSxJQUFJLGdDQUFtQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3pDLENBQUM7SUFDTCxDQUFDO0lBRWEsNEJBQWEsR0FBM0IsVUFBNEIsSUFBWSxFQUFFLFNBQWlCO1FBQ3ZELE1BQU0sQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQzVFLENBQUM7SUFFYSw2QkFBYyxHQUE1QixVQUE2QixVQUErQjtRQUN4RCxFQUFFLENBQUMsQ0FBQyxVQUFVLFlBQVksdUJBQVUsQ0FBQyxDQUFDLENBQUM7WUFDbkMsSUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUN4QyxJQUFJLFNBQVMsR0FBVyxFQUFFLENBQUM7WUFDM0IsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxJQUFJLENBQUMsTUFBTSxHQUFHLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO2dCQUMxQyxTQUFTLElBQUksY0FBYyxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLE9BQU8sQ0FBQztZQUNqSCxDQUFDO1lBQ0QsTUFBTSxDQUFDLFNBQVMsQ0FBQztRQUNyQixDQUFDO1FBQ0QsSUFBSSxDQUFDLENBQUM7WUFDRixNQUFNLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsU0FBUyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQ3hFLENBQUM7SUFDTCxDQUFDO0lBRWEsdUJBQVEsR0FBdEIsVUFBdUIsSUFBWTtRQUMvQixNQUFNLENBQUMsY0FBYyxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNwRSxDQUFDO0lBRWEsdUJBQVEsR0FBdEIsVUFBdUIsSUFBWTtRQUMvQixNQUFNLENBQUMsY0FBYyxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUN0RSxDQUFDO0lBRUQsc0JBQW1CLDJCQUFTO2FBQTVCO1lBQ0ksTUFBTSxDQUFDLEVBQUMsR0FBRyxFQUFFLGNBQWMsQ0FBQyxTQUFTLEVBQUUsT0FBTyxFQUFFLFNBQVMsQ0FBQyxpQkFBaUIsRUFBQyxDQUFDO1FBQ2pGLENBQUM7OztPQUFBO0lBWWMsK0JBQWdCLEdBQS9CLFVBQWdDLElBQVksRUFBRSxRQUF5QjtRQUF6Qix5QkFBQSxFQUFBLGlCQUF5QjtRQUNuRSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkMsTUFBTSxDQUFDLGVBQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ3ZDLENBQUM7UUFDRCxJQUFJLENBQUMsQ0FBQztZQUNGLE1BQU0sQ0FBQyxJQUFJLGVBQU0sQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDdEMsQ0FBQztJQUNMLENBQUM7SUFDTCxxQkFBQztBQUFELENBQUMsQUFoSEQ7QUE4Rm1CLHdCQUFTLEdBQUcsNGNBUU4sQ0FBQztBQXRHYix3Q0FBYyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGF1dGhvciAgVMO8bWF5IMOHZWJlciA8dHVtYXljZWJlckBnbWFpbC5jb20+XG4gKiBAbGluayAgICBodHRwczovL2dpdGh1Yi5jb20vYnJlbmR0dW1pL2JrbWV4cHJlc3NcbiAqIEBsaWNlbnNlIGh0dHA6Ly9vcGVuc291cmNlLm9yZy9saWNlbnNlcy9NSVRcbiAqIEBkYXRlIDI2LjA0LjIwMTdcbiAqL1xuXG5pbXBvcnQge0J1ZmZlcn0gZnJvbSBcImJ1ZmZlclwiO1xuaW1wb3J0ICogYXMgY3J5cHRvIGZyb20gXCJjcnlwdG9cIjtcbmltcG9ydCAqIGFzIGNvbnN0YW50cyBmcm9tIFwiY29uc3RhbnRzXCI7XG5pbXBvcnQgKiBhcyBzZW12ZXIgZnJvbSBcInNlbXZlclwiO1xuaW1wb3J0IHtWcG9zQ29uZmlnfSBmcm9tIFwiLi9yZXF1ZXN0L3Zwb3NDb25maWdcIjtcbmNvbnN0IG5vZGVWZXJzaW9uID0gc2VtdmVyLmNsZWFuKHByb2Nlc3MudmVyc2lvbik7XG5pbXBvcnQge0VuY3J5cHRpb25FeGNlcHRpb259IGZyb20gXCIuLi9leGNlcHRpb25zXCI7XG5pbXBvcnQge1JzYVB1YmxpY0tleX0gZnJvbSBcImNyeXB0b1wiO1xuXG5leHBvcnQgY2xhc3MgRW5jcnlwdGlvblV0aWwge1xuXG4gICAgcHVibGljIHN0YXRpYyBzaWduKHByaXZhdGVLZXk6IHN0cmluZywgZGF0YTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHNpZ24gPSBjcnlwdG8uY3JlYXRlU2lnbihcIlJTQS1TSEEyNTZcIik7XG4gICAgICAgICAgICBzaWduLnVwZGF0ZShkYXRhKTtcbiAgICAgICAgICAgIHJldHVybiBzaWduLnNpZ24ocHJpdmF0ZUtleSwgXCJiYXNlNjRcIik7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRW5jcnlwdGlvbkV4Y2VwdGlvbihlcnJvcik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIHZlcmlmeShwdWJsaWNLZXk6IHN0cmluZywgZGF0YTogc3RyaW5nLCBzaWduYXR1cmU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgdmVyaWZ5ID0gY3J5cHRvLmNyZWF0ZVZlcmlmeShcIlJTQS1TSEEyNTZcIik7XG4gICAgICAgICAgICB2ZXJpZnkudXBkYXRlKGRhdGEpO1xuICAgICAgICAgICAgcmV0dXJuIHZlcmlmeS52ZXJpZnkocHVibGljS2V5LCBzaWduYXR1cmUsIFwiYmFzZTY0XCIpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVuY3J5cHRpb25FeGNlcHRpb24oZXJyb3IpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBlbmNyeXB0KHB1YmxpY0tleTogc3RyaW5nIHwgUnNhUHVibGljS2V5LCBwbGFpbnRleHQ6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBwbGFpbkJ1ZmZlcjogQnVmZmVyID0gRW5jcnlwdGlvblV0aWwuYnVmZmVyRnJvbVN0cmluZyhwbGFpbnRleHQpO1xuICAgICAgICAgICAgbGV0IGNyeXB0OiBCdWZmZXI7XG5cbiAgICAgICAgICAgIGlmIChzZW12ZXIuZ3RlKG5vZGVWZXJzaW9uLCBcIjAuMTEuMTRcIikpIHtcbiAgICAgICAgICAgICAgICBjcnlwdCA9IGNyeXB0by5wdWJsaWNFbmNyeXB0KHB1YmxpY0tleSwgcGxhaW5CdWZmZXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3QgTm9kZVJTQTogYW55ID0gcmVxdWlyZShcIm5vZGUtcnNhXCIpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGtleTogYW55ID0gbmV3IE5vZGVSU0EocHVibGljS2V5KTtcbiAgICAgICAgICAgICAgICBjcnlwdCA9IGtleS5lbmNyeXB0KHBsYWluQnVmZmVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBjcnlwdC50b1N0cmluZyhcImJhc2U2NFwiKTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFbmNyeXB0aW9uRXhjZXB0aW9uKGVycm9yKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZGVjcnlwdChwcml2YXRlS2V5OiBzdHJpbmcsIHBsYWludGV4dDogc3RyaW5nLCBpc0Jhc2U2NDogYm9vbGVhbiA9IGZhbHNlKTogc3RyaW5nIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHBsYWluQnVmZmVyOiBCdWZmZXIgPSBFbmNyeXB0aW9uVXRpbC5idWZmZXJGcm9tU3RyaW5nKHBsYWludGV4dCwgaXNCYXNlNjQgPyBcImJhc2U2NFwiIDogXCJ1dGY4XCIpO1xuICAgICAgICAgICAgbGV0IGNyeXB0OiBCdWZmZXI7XG5cbiAgICAgICAgICAgIGlmIChzZW12ZXIuZ3RlKG5vZGVWZXJzaW9uLCBcIjAuMTEuMTRcIikpIHtcbiAgICAgICAgICAgICAgICBjcnlwdCA9IGNyeXB0by5wcml2YXRlRGVjcnlwdChwcml2YXRlS2V5LCBwbGFpbkJ1ZmZlcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBOb2RlUlNBOiBhbnkgPSByZXF1aXJlKFwibm9kZS1yc2FcIik7XG4gICAgICAgICAgICAgICAgY29uc3Qga2V5OiBhbnkgPSBuZXcgTm9kZVJTQShwcml2YXRlS2V5KTtcbiAgICAgICAgICAgICAgICBjcnlwdCA9IGtleS5kZWNyeXB0KHBsYWluQnVmZmVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBjcnlwdC50b1N0cmluZygpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVuY3J5cHRpb25FeGNlcHRpb24oZXJyb3IpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyB2ZXJpZnlCZXhTaWduKGRhdGE6IHN0cmluZywgc2lnbmF0dXJlOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIEVuY3J5cHRpb25VdGlsLnZlcmlmeShFbmNyeXB0aW9uVXRpbC5wdWJsaWNLZXksIGRhdGEsIHNpZ25hdHVyZSk7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBlbmNyeXB0V2l0aEJleCh2cG9zQ29uZmlnOiBWcG9zQ29uZmlnIHwgc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgaWYgKHZwb3NDb25maWcgaW5zdGFuY2VvZiBWcG9zQ29uZmlnKSB7XG4gICAgICAgICAgICBjb25zdCBkYXRhID0gSlNPTi5zdHJpbmdpZnkodnBvc0NvbmZpZyk7XG4gICAgICAgICAgICBsZXQgZW5jcnlwdGVkOiBzdHJpbmcgPSBcIlwiO1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPD0gZGF0YS5sZW5ndGggLyAyNDU7IGkrKykge1xuICAgICAgICAgICAgICAgIGVuY3J5cHRlZCArPSBFbmNyeXB0aW9uVXRpbC5lbmNyeXB0KEVuY3J5cHRpb25VdGlsLlB1YmxpY0tleSwgZGF0YS5zdWJzdHIoaSAqIDI0NSwgKGkgKyAxKSAqIDI0NSkpICsgXCJ8Oio6fFwiO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGVuY3J5cHRlZDtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBFbmNyeXB0aW9uVXRpbC5lbmNyeXB0KEVuY3J5cHRpb25VdGlsLlB1YmxpY0tleSwgdnBvc0NvbmZpZyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGVuY29kZTY0KGRhdGE6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBFbmNyeXB0aW9uVXRpbC5idWZmZXJGcm9tU3RyaW5nKGRhdGEpLnRvU3RyaW5nKFwiYmFzZTY0XCIpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZGVjb2RlNjQoZGF0YTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIEVuY3J5cHRpb25VdGlsLmJ1ZmZlckZyb21TdHJpbmcoZGF0YSwgXCJiYXNlNjRcIikudG9TdHJpbmcoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBnZXQgUHVibGljS2V5KCk6IFJzYVB1YmxpY0tleSB7XG4gICAgICAgIHJldHVybiB7a2V5OiBFbmNyeXB0aW9uVXRpbC5wdWJsaWNLZXksIHBhZGRpbmc6IGNvbnN0YW50cy5SU0FfUEtDUzFfUEFERElOR307XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgcHVibGljS2V5ID0gYC0tLS0tQkVHSU4gUFVCTElDIEtFWS0tLS0tXG5NSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXVaai9UUTlaUlk1S25zQTNITVBxXG5iTndJMzJKK0Jpc3l2N0tYN0lSSmg1ck41TFczZzd0NnB1bEFyTElFVTNzbjI4WlFFUStHQ2I5eXZrNnpJVW9xXG5LQnFIMEgrZ3Z4T3Rza2xPVWtGUmdoKy9GZ2hORG9lME96a1hUTGpRS2hoNk1STUJSOWwzY3dzOW5BMmN1K001XG5rdzY3RjhqMCs0U29nSEorVlMxd0Eya2ZXeDU4UE5ESWc5RHRBVndtRDFKYmpBemlQT052MHdIU2E4b05naWE5XG5UeDZpYTZGUzRuZmpSTnFwVnFJMG0yakljRzh5WHQxT2FCU2F6a3VSbFJlcE10RFZ3TUdGNHhPV1h1UlZ2K0c1XG5vaVRzYk9lejl0UUFjeCtLSDBXMVBuOVE5L3p6T0p5RjlBUzhKMVVERTdjN3JLd1hHRG51VEJVMUJ3ZEFHeUI4XG43UUlEQVFBQlxuLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tYDtcblxuICAgIHByaXZhdGUgc3RhdGljIGJ1ZmZlckZyb21TdHJpbmcoZGF0YTogc3RyaW5nLCBlbmNvZGluZzogc3RyaW5nID0gXCJ1dGY4XCIpOiBCdWZmZXIge1xuICAgICAgICBpZiAoc2VtdmVyLmd0ZShub2RlVmVyc2lvbiwgXCI2LjAuMFwiKSkge1xuICAgICAgICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKGRhdGEsIGVuY29kaW5nKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgQnVmZmVyKGRhdGEsIGVuY29kaW5nKTtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==