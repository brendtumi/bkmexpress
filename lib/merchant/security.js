"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var buffer_1 = require("buffer");
var constants_1 = require("constants");
var crypto_1 = require("crypto");
var semver = require("semver");
var vposConfig_1 = require("./request/vposConfig");
var nodeVersion = semver.clean(process.version);
var exceptions_1 = require("../exceptions");
var EncryptionUtil = (function () {
    function EncryptionUtil() {
    }
    EncryptionUtil.sign = function (privateKey, data) {
        try {
            var sign = crypto_1.createSign("RSA-SHA256");
            sign.update(data);
            return sign.sign(privateKey, "base64");
        }
        catch (error) {
            throw new exceptions_1.EncryptionException(error);
        }
    };
    EncryptionUtil.verify = function (publicKey, data, signature) {
        try {
            var verify = crypto_1.createVerify("RSA-SHA256");
            verify.update(data);
            return verify.verify(publicKey, signature, "base64");
        }
        catch (error) {
            throw new exceptions_1.EncryptionException(error);
        }
    };
    EncryptionUtil.encrypt = function (publicKey, plaintext) {
        try {
            var plainBuffer = EncryptionUtil.bufferFromString(plaintext);
            var crypt = void 0;
            if (semver.gte(nodeVersion, "0.11.14")) {
                crypt = crypto_1.publicEncrypt(publicKey, plainBuffer);
            }
            else {
                var NodeRSA = require("node-rsa");
                var key = new NodeRSA(publicKey);
                crypt = key.encrypt(plainBuffer);
            }
            return crypt.toString("base64");
        }
        catch (error) {
            throw new exceptions_1.EncryptionException(error);
        }
    };
    EncryptionUtil.decrypt = function (privateKey, plaintext, isBase64) {
        if (isBase64 === void 0) { isBase64 = false; }
        try {
            var plainBuffer = EncryptionUtil.bufferFromString(plaintext, isBase64 ? "base64" : "utf8");
            var crypt = void 0;
            if (semver.gte(nodeVersion, "0.11.14")) {
                crypt = crypto_1.privateDecrypt(privateKey, plainBuffer);
            }
            else {
                var NodeRSA = require("node-rsa");
                var key = new NodeRSA(privateKey);
                crypt = key.decrypt(plainBuffer);
            }
            return crypt.toString();
        }
        catch (error) {
            throw new exceptions_1.EncryptionException(error);
        }
    };
    EncryptionUtil.verifyBexSign = function (data, signature) {
        return EncryptionUtil.verify(EncryptionUtil.publicKey, data, signature);
    };
    EncryptionUtil.encryptWithBex = function (vposConfig) {
        if (vposConfig instanceof vposConfig_1.VposConfig) {
            var data = JSON.stringify(vposConfig);
            var encrypted = "";
            for (var i = 0; i <= data.length / 245; i++) {
                encrypted += EncryptionUtil.encrypt(EncryptionUtil.PublicKey, data.substr(i * 245, (i + 1) * 245)) + "|:*:|";
            }
            return encrypted;
        }
        else {
            return EncryptionUtil.encrypt(EncryptionUtil.PublicKey, vposConfig);
        }
    };
    EncryptionUtil.encode64 = function (data) {
        return EncryptionUtil.bufferFromString(data).toString("base64");
    };
    EncryptionUtil.decode64 = function (data) {
        return EncryptionUtil.bufferFromString(data, "base64").toString();
    };
    Object.defineProperty(EncryptionUtil, "PublicKey", {
        get: function () {
            return { key: EncryptionUtil.publicKey, padding: constants_1.RSA_PKCS1_PADDING };
        },
        enumerable: true,
        configurable: true
    });
    EncryptionUtil.bufferFromString = function (data, encoding) {
        if (encoding === void 0) { encoding = "utf8"; }
        if (semver.gte(nodeVersion, "6.0.0")) {
            return buffer_1.Buffer.from(data, encoding);
        }
        else {
            return new buffer_1.Buffer(data, encoding);
        }
    };
    EncryptionUtil.publicKey = "-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuZj/TQ9ZRY5KnsA3HMPq\nbNwI32J+Bisyv7KX7IRJh5rN5LW3g7t6pulArLIEU3sn28ZQEQ+GCb9yvk6zIUoq\nKBqH0H+gvxOtsklOUkFRgh+/FghNDoe0OzkXTLjQKhh6MRMBR9l3cws9nA2cu+M5\nkw67F8j0+4SogHJ+VS1wA2kfWx58PNDIg9DtAVwmD1JbjAziPONv0wHSa8oNgia9\nTx6ia6FS4nfjRNqpVqI0m2jIcG8yXt1OaBSazkuRlRepMtDVwMGF4xOWXuRVv+G5\noiTsbOez9tQAcx+KH0W1Pn9Q9/zzOJyF9AS8J1UDE7c7rKwXGDnuTBU1BwdAGyB8\n7QIDAQAB\n-----END PUBLIC KEY-----";
    return EncryptionUtil;
}());
exports.EncryptionUtil = EncryptionUtil;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VjdXJpdHkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbWVyY2hhbnQvc2VjdXJpdHkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFPQSxpQ0FBOEI7QUFDOUIsdUNBQTRDO0FBQzVDLGlDQUE2RjtBQUM3RiwrQkFBaUM7QUFDakMsbURBQWdEO0FBQ2hELElBQU0sV0FBVyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQ2xELDRDQUFrRDtBQUVsRDtJQUFBO0lBZ0hBLENBQUM7SUE5R2lCLG1CQUFJLEdBQWxCLFVBQW1CLFVBQWtCLEVBQUUsSUFBWTtRQUMvQyxJQUFJO1lBQ0EsSUFBTSxJQUFJLEdBQUcsbUJBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUN0QyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2xCLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsUUFBUSxDQUFDLENBQUM7U0FDMUM7UUFDRCxPQUFPLEtBQUssRUFBRTtZQUNWLE1BQU0sSUFBSSxnQ0FBbUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUN4QztJQUNMLENBQUM7SUFFYSxxQkFBTSxHQUFwQixVQUFxQixTQUFpQixFQUFFLElBQVksRUFBRSxTQUFpQjtRQUNuRSxJQUFJO1lBQ0EsSUFBTSxNQUFNLEdBQUcscUJBQVksQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUMxQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3BCLE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQyxTQUFTLEVBQUUsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1NBQ3hEO1FBQ0QsT0FBTyxLQUFLLEVBQUU7WUFDVixNQUFNLElBQUksZ0NBQW1CLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDeEM7SUFDTCxDQUFDO0lBRWEsc0JBQU8sR0FBckIsVUFBc0IsU0FBZ0MsRUFBRSxTQUFp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LENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3BFLENBQUM7SUFFYSx1QkFBUSxHQUF0QixVQUF1QixJQUFZO1FBQy9CLE9BQU8sY0FBYyxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUN0RSxDQUFDO0lBRUQsc0JBQW1CLDJCQUFTO2FBQTVCO1lBQ0ksT0FBTyxFQUFDLEdBQUcsRUFBRSxjQUFjLENBQUMsU0FBUyxFQUFFLE9BQU8sRUFBRSw2QkFBaUIsRUFBQyxDQUFDO1FBQ3ZFLENBQUM7OztPQUFBO0lBWWMsK0JBQWdCLEdBQS9CLFVBQWdDLElBQVksRUFBRSxRQUF5QjtRQUF6Qix5QkFBQSxFQUFBLGlCQUF5QjtRQUNuRSxJQUFJLE1BQU0sQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLE9BQU8sQ0FBQyxFQUFFO1lBQ2xDLE9BQU8sZUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7U0FDdEM7YUFDSTtZQUNELE9BQU8sSUFBSSxlQUFNLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1NBQ3JDO0lBQ0wsQ0FBQztJQWpCYyx3QkFBUyxHQUFHLDRjQVFOLENBQUM7SUFVMUIscUJBQUM7Q0FBQSxBQWhIRCxJQWdIQztBQWhIWSx3Q0FBYyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGF1dGhvciAgVMO8bWF5IMOHZWJlciA8dHVtYXljZWJlckBnbWFpbC5jb20+XG4gKiBAbGluayAgICBodHRwczovL2dpdGh1Yi5jb20vYnJlbmR0dW1pL2JrbWV4cHJlc3NcbiAqIEBsaWNlbnNlIGh0dHA6Ly9vcGVuc291cmNlLm9yZy9saWNlbnNlcy9NSVRcbiAqIEBkYXRlIDI2LjA0LjIwMTdcbiAqL1xuXG5pbXBvcnQge0J1ZmZlcn0gZnJvbSBcImJ1ZmZlclwiO1xuaW1wb3J0IHtSU0FfUEtDUzFfUEFERElOR30gZnJvbSBcImNvbnN0YW50c1wiO1xuaW1wb3J0IHtjcmVhdGVTaWduLCBjcmVhdGVWZXJpZnksIHByaXZhdGVEZWNyeXB0LCBwdWJsaWNFbmNyeXB0LCBSc2FQdWJsaWNLZXl9IGZyb20gXCJjcnlwdG9cIjtcbmltcG9ydCAqIGFzIHNlbXZlciBmcm9tIFwic2VtdmVyXCI7XG5pbXBvcnQge1Zwb3NDb25maWd9IGZyb20gXCIuL3JlcXVlc3QvdnBvc0NvbmZpZ1wiO1xuY29uc3Qgbm9kZVZlcnNpb24gPSBzZW12ZXIuY2xlYW4ocHJvY2Vzcy52ZXJzaW9uKTtcbmltcG9ydCB7RW5jcnlwdGlvbkV4Y2VwdGlvbn0gZnJvbSBcIi4uL2V4Y2VwdGlvbnNcIjtcblxuZXhwb3J0IGNsYXNzIEVuY3J5cHRpb25VdGlsIHtcblxuICAgIHB1YmxpYyBzdGF0aWMgc2lnbihwcml2YXRlS2V5OiBzdHJpbmcsIGRhdGE6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBzaWduID0gY3JlYXRlU2lnbihcIlJTQS1TSEEyNTZcIik7XG4gICAgICAgICAgICBzaWduLnVwZGF0ZShkYXRhKTtcbiAgICAgICAgICAgIHJldHVybiBzaWduLnNpZ24ocHJpdmF0ZUtleSwgXCJiYXNlNjRcIik7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRW5jcnlwdGlvbkV4Y2VwdGlvbihlcnJvcik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIHZlcmlmeShwdWJsaWNLZXk6IHN0cmluZywgZGF0YTogc3RyaW5nLCBzaWduYXR1cmU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgdmVyaWZ5ID0gY3JlYXRlVmVyaWZ5KFwiUlNBLVNIQTI1NlwiKTtcbiAgICAgICAgICAgIHZlcmlmeS51cGRhdGUoZGF0YSk7XG4gICAgICAgICAgICByZXR1cm4gdmVyaWZ5LnZlcmlmeShwdWJsaWNLZXksIHNpZ25hdHVyZSwgXCJiYXNlNjRcIik7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRW5jcnlwdGlvbkV4Y2VwdGlvbihlcnJvcik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGVuY3J5cHQocHVibGljS2V5OiBzdHJpbmcgfCBSc2FQdWJsaWNLZXksIHBsYWludGV4dDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHBsYWluQnVmZmVyOiBCdWZmZXIgPSBFbmNyeXB0aW9uVXRpbC5idWZmZXJGcm9tU3RyaW5nKHBsYWludGV4dCk7XG4gICAgICAgICAgICBsZXQgY3J5cHQ6IEJ1ZmZlcjtcblxuICAgICAgICAgICAgaWYgKHNlbXZlci5ndGUobm9kZVZlcnNpb24sIFwiMC4xMS4xNFwiKSkge1xuICAgICAgICAgICAgICAgIGNyeXB0ID0gcHVibGljRW5jcnlwdChwdWJsaWNLZXksIHBsYWluQnVmZmVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0IE5vZGVSU0E6IGFueSA9IHJlcXVpcmUoXCJub2RlLXJzYVwiKTtcbiAgICAgICAgICAgICAgICBjb25zdCBrZXk6IGFueSA9IG5ldyBOb2RlUlNBKHB1YmxpY0tleSk7XG4gICAgICAgICAgICAgICAgY3J5cHQgPSBrZXkuZW5jcnlwdChwbGFpbkJ1ZmZlcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gY3J5cHQudG9TdHJpbmcoXCJiYXNlNjRcIik7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRW5jcnlwdGlvbkV4Y2VwdGlvbihlcnJvcik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGRlY3J5cHQocHJpdmF0ZUtleTogc3RyaW5nLCBwbGFpbnRleHQ6IHN0cmluZywgaXNCYXNlNjQ6IGJvb2xlYW4gPSBmYWxzZSk6IHN0cmluZyB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBwbGFpbkJ1ZmZlcjogQnVmZmVyID0gRW5jcnlwdGlvblV0aWwuYnVmZmVyRnJvbVN0cmluZyhwbGFpbnRleHQsIGlzQmFzZTY0ID8gXCJiYXNlNjRcIiA6IFwidXRmOFwiKTtcbiAgICAgICAgICAgIGxldCBjcnlwdDogQnVmZmVyO1xuXG4gICAgICAgICAgICBpZiAoc2VtdmVyLmd0ZShub2RlVmVyc2lvbiwgXCIwLjExLjE0XCIpKSB7XG4gICAgICAgICAgICAgICAgY3J5cHQgPSBwcml2YXRlRGVjcnlwdChwcml2YXRlS2V5LCBwbGFpbkJ1ZmZlcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBOb2RlUlNBOiBhbnkgPSByZXF1aXJlKFwibm9kZS1yc2FcIik7XG4gICAgICAgICAgICAgICAgY29uc3Qga2V5OiBhbnkgPSBuZXcgTm9kZVJTQShwcml2YXRlS2V5KTtcbiAgICAgICAgICAgICAgICBjcnlwdCA9IGtleS5kZWNyeXB0KHBsYWluQnVmZmVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBjcnlwdC50b1N0cmluZygpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVuY3J5cHRpb25FeGNlcHRpb24oZXJyb3IpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyB2ZXJpZnlCZXhTaWduKGRhdGE6IHN0cmluZywgc2lnbmF0dXJlOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIEVuY3J5cHRpb25VdGlsLnZlcmlmeShFbmNyeXB0aW9uVXRpbC5wdWJsaWNLZXksIGRhdGEsIHNpZ25hdHVyZSk7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBlbmNyeXB0V2l0aEJleCh2cG9zQ29uZmlnOiBWcG9zQ29uZmlnIHwgc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgaWYgKHZwb3NDb25maWcgaW5zdGFuY2VvZiBWcG9zQ29uZmlnKSB7XG4gICAgICAgICAgICBjb25zdCBkYXRhID0gSlNPTi5zdHJpbmdpZnkodnBvc0NvbmZpZyk7XG4gICAgICAgICAgICBsZXQgZW5jcnlwdGVkOiBzdHJpbmcgPSBcIlwiO1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPD0gZGF0YS5sZW5ndGggLyAyNDU7IGkrKykge1xuICAgICAgICAgICAgICAgIGVuY3J5cHRlZCArPSBFbmNyeXB0aW9uVXRpbC5lbmNyeXB0KEVuY3J5cHRpb25VdGlsLlB1YmxpY0tleSwgZGF0YS5zdWJzdHIoaSAqIDI0NSwgKGkgKyAxKSAqIDI0NSkpICsgXCJ8Oio6fFwiO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGVuY3J5cHRlZDtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBFbmNyeXB0aW9uVXRpbC5lbmNyeXB0KEVuY3J5cHRpb25VdGlsLlB1YmxpY0tleSwgdnBvc0NvbmZpZyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGVuY29kZTY0KGRhdGE6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBFbmNyeXB0aW9uVXRpbC5idWZmZXJGcm9tU3RyaW5nKGRhdGEpLnRvU3RyaW5nKFwiYmFzZTY0XCIpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZGVjb2RlNjQoZGF0YTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIEVuY3J5cHRpb25VdGlsLmJ1ZmZlckZyb21TdHJpbmcoZGF0YSwgXCJiYXNlNjRcIikudG9TdHJpbmcoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBnZXQgUHVibGljS2V5KCk6IFJzYVB1YmxpY0tleSB7XG4gICAgICAgIHJldHVybiB7a2V5OiBFbmNyeXB0aW9uVXRpbC5wdWJsaWNLZXksIHBhZGRpbmc6IFJTQV9QS0NTMV9QQURESU5HfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBwdWJsaWNLZXkgPSBgLS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS1cbk1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBdVpqL1RROVpSWTVLbnNBM0hNUHFcbmJOd0kzMkorQmlzeXY3S1g3SVJKaDVyTjVMVzNnN3Q2cHVsQXJMSUVVM3NuMjhaUUVRK0dDYjl5dms2eklVb3FcbktCcUgwSCtndnhPdHNrbE9Va0ZSZ2grL0ZnaE5Eb2UwT3prWFRMalFLaGg2TVJNQlI5bDNjd3M5bkEyY3UrTTVcbmt3NjdGOGowKzRTb2dISitWUzF3QTJrZld4NThQTkRJZzlEdEFWd21EMUpiakF6aVBPTnYwd0hTYThvTmdpYTlcblR4NmlhNkZTNG5malJOcXBWcUkwbTJqSWNHOHlYdDFPYUJTYXprdVJsUmVwTXREVndNR0Y0eE9XWHVSVnYrRzVcbm9pVHNiT2V6OXRRQWN4K0tIMFcxUG45UTkvenpPSnlGOUFTOEoxVURFN2M3ckt3WEdEbnVUQlUxQndkQUd5QjhcbjdRSURBUUFCXG4tLS0tLUVORCBQVUJMSUMgS0VZLS0tLS1gO1xuXG4gICAgcHJpdmF0ZSBzdGF0aWMgYnVmZmVyRnJvbVN0cmluZyhkYXRhOiBzdHJpbmcsIGVuY29kaW5nOiBzdHJpbmcgPSBcInV0ZjhcIik6IEJ1ZmZlciB7XG4gICAgICAgIGlmIChzZW12ZXIuZ3RlKG5vZGVWZXJzaW9uLCBcIjYuMC4wXCIpKSB7XG4gICAgICAgICAgICByZXR1cm4gQnVmZmVyLmZyb20oZGF0YSwgZW5jb2RpbmcpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBCdWZmZXIoZGF0YSwgZW5jb2RpbmcpO1xuICAgICAgICB9XG4gICAgfVxufVxuIl19