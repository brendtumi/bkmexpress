"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var buffer_1 = require("buffer");
var constants_1 = require("constants");
var crypto_1 = require("crypto");
var semver = require("semver");
var vposConfig_1 = require("./request/vposConfig");
var nodeVersion = semver.clean(process.version);
var exceptions_1 = require("../exceptions");
var EncryptionUtil = (function () {
    function EncryptionUtil() {
    }
    EncryptionUtil.sign = function (privateKey, data) {
        try {
            var sign = crypto_1.createSign("RSA-SHA256");
            sign.update(data);
            return sign.sign(privateKey, "base64");
        }
        catch (error) {
            throw new exceptions_1.EncryptionException(error);
        }
    };
    EncryptionUtil.verify = function (publicKey, data, signature) {
        try {
            var verify = crypto_1.createVerify("RSA-SHA256");
            verify.update(data);
            return verify.verify(publicKey, signature, "base64");
        }
        catch (error) {
            throw new exceptions_1.EncryptionException(error);
        }
    };
    EncryptionUtil.encrypt = function (publicKey, plaintext) {
        try {
            var plainBuffer = EncryptionUtil.bufferFromString(plaintext);
            var crypt = void 0;
            if (semver.gte(nodeVersion, "0.11.14")) {
                crypt = crypto_1.publicEncrypt(publicKey, plainBuffer);
            }
            else {
                var NodeRSA = require("node-rsa");
                var key = new NodeRSA(publicKey);
                crypt = key.encrypt(plainBuffer);
            }
            return crypt.toString("base64");
        }
        catch (error) {
            throw new exceptions_1.EncryptionException(error);
        }
    };
    EncryptionUtil.decrypt = function (privateKey, plaintext, isBase64) {
        if (isBase64 === void 0) { isBase64 = false; }
        try {
            var plainBuffer = EncryptionUtil.bufferFromString(plaintext, isBase64 ? "base64" : "utf8");
            var crypt = void 0;
            if (semver.gte(nodeVersion, "0.11.14")) {
                crypt = crypto_1.privateDecrypt(privateKey, plainBuffer);
            }
            else {
                var NodeRSA = require("node-rsa");
                var key = new NodeRSA(privateKey);
                crypt = key.decrypt(plainBuffer);
            }
            return crypt.toString();
        }
        catch (error) {
            throw new exceptions_1.EncryptionException(error);
        }
    };
    EncryptionUtil.verifyBexSign = function (data, signature) {
        return EncryptionUtil.verify(EncryptionUtil.publicKey, data, signature);
    };
    EncryptionUtil.encryptWithBex = function (vposConfig) {
        if (vposConfig instanceof vposConfig_1.VposConfig) {
            var data = JSON.stringify(vposConfig);
            var encrypted = "";
            for (var i = 0; i <= data.length / 245; i++) {
                encrypted += EncryptionUtil.encrypt(EncryptionUtil.PublicKey, data.substr(i * 245, (i + 1) * 245)) + "|:*:|";
            }
            return encrypted;
        }
        else {
            return EncryptionUtil.encrypt(EncryptionUtil.PublicKey, vposConfig);
        }
    };
    EncryptionUtil.encode64 = function (data) {
        return EncryptionUtil.bufferFromString(data).toString("base64");
    };
    EncryptionUtil.decode64 = function (data) {
        return EncryptionUtil.bufferFromString(data, "base64").toString();
    };
    Object.defineProperty(EncryptionUtil, "PublicKey", {
        get: function () {
            return { key: EncryptionUtil.publicKey, padding: constants_1.RSA_PKCS1_PADDING };
        },
        enumerable: true,
        configurable: true
    });
    EncryptionUtil.bufferFromString = function (data, encoding) {
        if (encoding === void 0) { encoding = "utf8"; }
        if (semver.gte(nodeVersion, "6.0.0")) {
            return buffer_1.Buffer.from(data, encoding);
        }
        else {
            return new buffer_1.Buffer(data, encoding);
        }
    };
    EncryptionUtil.publicKey = "-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuZj/TQ9ZRY5KnsA3HMPq\nbNwI32J+Bisyv7KX7IRJh5rN5LW3g7t6pulArLIEU3sn28ZQEQ+GCb9yvk6zIUoq\nKBqH0H+gvxOtsklOUkFRgh+/FghNDoe0OzkXTLjQKhh6MRMBR9l3cws9nA2cu+M5\nkw67F8j0+4SogHJ+VS1wA2kfWx58PNDIg9DtAVwmD1JbjAziPONv0wHSa8oNgia9\nTx6ia6FS4nfjRNqpVqI0m2jIcG8yXt1OaBSazkuRlRepMtDVwMGF4xOWXuRVv+G5\noiTsbOez9tQAcx+KH0W1Pn9Q9/zzOJyF9AS8J1UDE7c7rKwXGDnuTBU1BwdAGyB8\n7QIDAQAB\n-----END PUBLIC KEY-----";
    return EncryptionUtil;
}());
exports.EncryptionUtil = EncryptionUtil;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VjdXJpdHkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbWVyY2hhbnQvc2VjdXJpdHkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFPQSxpQ0FBOEI7QUFDOUIsdUNBQTRDO0FBQzVDLGlDQUE2RjtBQUM3RiwrQkFBaUM7QUFDakMsbURBQWdEO0FBQ2hELElBQU0sV0FBVyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQ2xELDRDQUFrRDtBQUVsRDtJQUFBO0lBZ0hBLENBQUM7SUE5R2lCLG1CQUFJLEdBQWxCLFVBQW1CLFVBQWtCLEVBQUUsSUFBWTtRQUMvQyxJQUFJLENBQUM7WUFDRCxJQUFNLElBQUksR0FBRyxtQkFBVSxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQ3RDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDbEIsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQzNDLENBQUM7UUFDRCxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ1gsTUFBTSxJQUFJLGdDQUFtQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3pDLENBQUM7SUFDTCxDQUFDO0lBRWEscUJBQU0sR0FBcEIsVUFBcUIsU0FBaUIsRUFBRSxJQUFZLEVBQUUsU0FBaUI7UUFDbkUsSUFBSSxDQUFDO1lBQ0QsSUFBTSxNQUFNLEdBQUcscUJBQVksQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUMxQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3BCLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxTQUFTLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDekQsQ0FBQztRQUNELEtBQUssQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDWCxNQUFNLElBQUksZ0NBQW1C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SUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ3RDLENBQUM7SUFDTCxDQUFDO0lBakJjLHdCQUFTLEdBQUcsNGNBUU4sQ0FBQztJQVUxQixxQkFBQztDQUFBLEFBaEhELElBZ0hDO0FBaEhZLHdDQUFjIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAYXV0aG9yICBUw7xtYXkgw4dlYmVyIDx0dW1heWNlYmVyQGdtYWlsLmNvbT5cbiAqIEBsaW5rICAgIGh0dHBzOi8vZ2l0aHViLmNvbS9icmVuZHR1bWkvYmttZXhwcmVzc1xuICogQGxpY2Vuc2UgaHR0cDovL29wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL01JVFxuICogQGRhdGUgMjYuMDQuMjAxN1xuICovXG5cbmltcG9ydCB7QnVmZmVyfSBmcm9tIFwiYnVmZmVyXCI7XG5pbXBvcnQge1JTQV9QS0NTMV9QQURESU5HfSBmcm9tIFwiY29uc3RhbnRzXCI7XG5pbXBvcnQge2NyZWF0ZVNpZ24sIGNyZWF0ZVZlcmlmeSwgcHJpdmF0ZURlY3J5cHQsIHB1YmxpY0VuY3J5cHQsIFJzYVB1YmxpY0tleX0gZnJvbSBcImNyeXB0b1wiO1xuaW1wb3J0ICogYXMgc2VtdmVyIGZyb20gXCJzZW12ZXJcIjtcbmltcG9ydCB7VnBvc0NvbmZpZ30gZnJvbSBcIi4vcmVxdWVzdC92cG9zQ29uZmlnXCI7XG5jb25zdCBub2RlVmVyc2lvbiA9IHNlbXZlci5jbGVhbihwcm9jZXNzLnZlcnNpb24pO1xuaW1wb3J0IHtFbmNyeXB0aW9uRXhjZXB0aW9ufSBmcm9tIFwiLi4vZXhjZXB0aW9uc1wiO1xuXG5leHBvcnQgY2xhc3MgRW5jcnlwdGlvblV0aWwge1xuXG4gICAgcHVibGljIHN0YXRpYyBzaWduKHByaXZhdGVLZXk6IHN0cmluZywgZGF0YTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHNpZ24gPSBjcmVhdGVTaWduKFwiUlNBLVNIQTI1NlwiKTtcbiAgICAgICAgICAgIHNpZ24udXBkYXRlKGRhdGEpO1xuICAgICAgICAgICAgcmV0dXJuIHNpZ24uc2lnbihwcml2YXRlS2V5LCBcImJhc2U2NFwiKTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFbmNyeXB0aW9uRXhjZXB0aW9uKGVycm9yKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgdmVyaWZ5KHB1YmxpY0tleTogc3RyaW5nLCBkYXRhOiBzdHJpbmcsIHNpZ25hdHVyZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCB2ZXJpZnkgPSBjcmVhdGVWZXJpZnkoXCJSU0EtU0hBMjU2XCIpO1xuICAgICAgICAgICAgdmVyaWZ5LnVwZGF0ZShkYXRhKTtcbiAgICAgICAgICAgIHJldHVybiB2ZXJpZnkudmVyaWZ5KHB1YmxpY0tleSwgc2lnbmF0dXJlLCBcImJhc2U2NFwiKTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFbmNyeXB0aW9uRXhjZXB0aW9uKGVycm9yKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZW5jcnlwdChwdWJsaWNLZXk6IHN0cmluZyB8IFJzYVB1YmxpY0tleSwgcGxhaW50ZXh0OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgcGxhaW5CdWZmZXI6IEJ1ZmZlciA9IEVuY3J5cHRpb25VdGlsLmJ1ZmZlckZyb21TdHJpbmcocGxhaW50ZXh0KTtcbiAgICAgICAgICAgIGxldCBjcnlwdDogQnVmZmVyO1xuXG4gICAgICAgICAgICBpZiAoc2VtdmVyLmd0ZShub2RlVmVyc2lvbiwgXCIwLjExLjE0XCIpKSB7XG4gICAgICAgICAgICAgICAgY3J5cHQgPSBwdWJsaWNFbmNyeXB0KHB1YmxpY0tleSwgcGxhaW5CdWZmZXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3QgTm9kZVJTQTogYW55ID0gcmVxdWlyZShcIm5vZGUtcnNhXCIpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGtleTogYW55ID0gbmV3IE5vZGVSU0EocHVibGljS2V5KTtcbiAgICAgICAgICAgICAgICBjcnlwdCA9IGtleS5lbmNyeXB0KHBsYWluQnVmZmVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBjcnlwdC50b1N0cmluZyhcImJhc2U2NFwiKTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFbmNyeXB0aW9uRXhjZXB0aW9uKGVycm9yKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZGVjcnlwdChwcml2YXRlS2V5OiBzdHJpbmcsIHBsYWludGV4dDogc3RyaW5nLCBpc0Jhc2U2NDogYm9vbGVhbiA9IGZhbHNlKTogc3RyaW5nIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHBsYWluQnVmZmVyOiBCdWZmZXIgPSBFbmNyeXB0aW9uVXRpbC5idWZmZXJGcm9tU3RyaW5nKHBsYWludGV4dCwgaXNCYXNlNjQgPyBcImJhc2U2NFwiIDogXCJ1dGY4XCIpO1xuICAgICAgICAgICAgbGV0IGNyeXB0OiBCdWZmZXI7XG5cbiAgICAgICAgICAgIGlmIChzZW12ZXIuZ3RlKG5vZGVWZXJzaW9uLCBcIjAuMTEuMTRcIikpIHtcbiAgICAgICAgICAgICAgICBjcnlwdCA9IHByaXZhdGVEZWNyeXB0KHByaXZhdGVLZXksIHBsYWluQnVmZmVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0IE5vZGVSU0E6IGFueSA9IHJlcXVpcmUoXCJub2RlLXJzYVwiKTtcbiAgICAgICAgICAgICAgICBjb25zdCBrZXk6IGFueSA9IG5ldyBOb2RlUlNBKHByaXZhdGVLZXkpO1xuICAgICAgICAgICAgICAgIGNyeXB0ID0ga2V5LmRlY3J5cHQocGxhaW5CdWZmZXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGNyeXB0LnRvU3RyaW5nKCk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRW5jcnlwdGlvbkV4Y2VwdGlvbihlcnJvcik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIHZlcmlmeUJleFNpZ24oZGF0YTogc3RyaW5nLCBzaWduYXR1cmU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gRW5jcnlwdGlvblV0aWwudmVyaWZ5KEVuY3J5cHRpb25VdGlsLnB1YmxpY0tleSwgZGF0YSwgc2lnbmF0dXJlKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGVuY3J5cHRXaXRoQmV4KHZwb3NDb25maWc6IFZwb3NDb25maWcgfCBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICBpZiAodnBvc0NvbmZpZyBpbnN0YW5jZW9mIFZwb3NDb25maWcpIHtcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBKU09OLnN0cmluZ2lmeSh2cG9zQ29uZmlnKTtcbiAgICAgICAgICAgIGxldCBlbmNyeXB0ZWQ6IHN0cmluZyA9IFwiXCI7XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8PSBkYXRhLmxlbmd0aCAvIDI0NTsgaSsrKSB7XG4gICAgICAgICAgICAgICAgZW5jcnlwdGVkICs9IEVuY3J5cHRpb25VdGlsLmVuY3J5cHQoRW5jcnlwdGlvblV0aWwuUHVibGljS2V5LCBkYXRhLnN1YnN0cihpICogMjQ1LCAoaSArIDEpICogMjQ1KSkgKyBcInw6Kjp8XCI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZW5jcnlwdGVkO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIEVuY3J5cHRpb25VdGlsLmVuY3J5cHQoRW5jcnlwdGlvblV0aWwuUHVibGljS2V5LCB2cG9zQ29uZmlnKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZW5jb2RlNjQoZGF0YTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIEVuY3J5cHRpb25VdGlsLmJ1ZmZlckZyb21TdHJpbmcoZGF0YSkudG9TdHJpbmcoXCJiYXNlNjRcIik7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBkZWNvZGU2NChkYXRhOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gRW5jcnlwdGlvblV0aWwuYnVmZmVyRnJvbVN0cmluZyhkYXRhLCBcImJhc2U2NFwiKS50b1N0cmluZygpO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIGdldCBQdWJsaWNLZXkoKTogUnNhUHVibGljS2V5IHtcbiAgICAgICAgcmV0dXJuIHtrZXk6IEVuY3J5cHRpb25VdGlsLnB1YmxpY0tleSwgcGFkZGluZzogUlNBX1BLQ1MxX1BBRERJTkd9O1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIHB1YmxpY0tleSA9IGAtLS0tLUJFR0lOIFBVQkxJQyBLRVktLS0tLVxuTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUF1WmovVFE5WlJZNUtuc0EzSE1QcVxuYk53STMySitCaXN5djdLWDdJUkpoNXJONUxXM2c3dDZwdWxBckxJRVUzc24yOFpRRVErR0NiOXl2azZ6SVVvcVxuS0JxSDBIK2d2eE90c2tsT1VrRlJnaCsvRmdoTkRvZTBPemtYVExqUUtoaDZNUk1CUjlsM2N3czluQTJjdStNNVxua3c2N0Y4ajArNFNvZ0hKK1ZTMXdBMmtmV3g1OFBORElnOUR0QVZ3bUQxSmJqQXppUE9OdjB3SFNhOG9OZ2lhOVxuVHg2aWE2RlM0bmZqUk5xcFZxSTBtMmpJY0c4eVh0MU9hQlNhemt1UmxSZXBNdERWd01HRjR4T1dYdVJWditHNVxub2lUc2JPZXo5dFFBY3grS0gwVzFQbjlROS96ek9KeUY5QVM4SjFVREU3YzdyS3dYR0RudVRCVTFCd2RBR3lCOFxuN1FJREFRQUJcbi0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLWA7XG5cbiAgICBwcml2YXRlIHN0YXRpYyBidWZmZXJGcm9tU3RyaW5nKGRhdGE6IHN0cmluZywgZW5jb2Rpbmc6IHN0cmluZyA9IFwidXRmOFwiKTogQnVmZmVyIHtcbiAgICAgICAgaWYgKHNlbXZlci5ndGUobm9kZVZlcnNpb24sIFwiNi4wLjBcIikpIHtcbiAgICAgICAgICAgIHJldHVybiBCdWZmZXIuZnJvbShkYXRhLCBlbmNvZGluZyk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IEJ1ZmZlcihkYXRhLCBlbmNvZGluZyk7XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=